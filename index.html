<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PicklePulse ‚Äî Pickleball Stats & RR Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #050816;
      --card: #0f172a;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #ef4444;
      --border: #1f2937;
      --radius-xl: 24px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 40%, #000 100%);
      color: var(--text);
      padding: 16px;
    }

    .app-shell { max-width: 960px; margin: 0 auto 40px; }

    header {
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px; margin-bottom: 18px;
    }

    .brand { display: flex; align-items: center; gap: 10px; }

    .brand-icon {
      width: 40px; height: 40px; border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #4ade80, #22c55e);
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; color: #022c22; font-size: 20px;
    }

    .brand-text-title { font-weight: 700; font-size: 18px; }
    .brand-text-sub { font-size: 12px; color: var(--muted); }

    header .tagline {
      font-size: 12px; color: var(--muted); max-width: 180px; text-align: right;
    }

    @media (max-width: 768px) {
      header { flex-direction: column; align-items: flex-start; }
      header .tagline { text-align: left; }
    }

    .grid {
      display: grid; grid-template-columns: minmax(0, 1.15fr) minmax(0, 1fr);
      gap: 16px;
    }

    @media (max-width: 768px) {
      .grid { grid-template-columns: minmax(0, 1fr); }
    }

    .card {
      background: radial-gradient(circle at top left, #111827, #020617);
      border-radius: var(--radius-xl); padding: 16px 14px 14px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.55);
    }

    .card-header {
      display: flex; justify-content: space-between; align-items: center;
      gap: 10px; margin-bottom: 12px;
    }

    .card-title { font-size: 14px; font-weight: 600; }
    .card-subtitle { font-size: 11px; color: var(--muted); }

    .pill {
      font-size: 11px; padding: 4px 8px; border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--muted);
      display: inline-flex; align-items: center; gap: 4px;
    }

    form {
      display: grid; grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
    }

    .field { display: flex; flex-direction: column; gap: 4px; }
    .field-full { grid-column: 1 / -1; }

    label {
      font-size: 11px; text-transform: uppercase; letter-spacing: 0.06em;
      color: var(--muted);
    }

    input, select, textarea {
      background: #020617; border-radius: 12px;
      border: 1px solid #1f2937; padding: 8px 10px;
      color: var(--text); font-size: 13px; outline: none;
    }

    textarea { resize: vertical; min-height: 48px; }

    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.5);
    }

    .score-inputs { display: flex; align-items: center; gap: 4px; }
    .score-inputs input { text-align: center; }

    .chips-row { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }

    .chip-toggle {
      font-size: 11px; padding: 4px 8px; border-radius: 999px;
      border: 1px solid #1f2937; background: #020617;
      cursor: pointer; color: var(--muted);
    }

    .chip-toggle.active {
      border-color: var(--accent); background: var(--accent-soft); color: var(--accent);
    }

    .btn-row { display: flex; gap: 8px; margin-top: 10px; }

    button {
      border-radius: 999px; border: none; padding: 9px 12px;
      font-size: 13px; font-weight: 500; cursor: pointer;
      display: inline-flex; align-items: center; justify-content: center;
    }

    .btn-primary {
      flex: 1; background: linear-gradient(135deg, #22c55e, #4ade80);
      color: #022c22; box-shadow: 0 10px 25px rgba(34,197,94,0.55);
    }

    .btn-ghost { background: rgba(15,23,42,0.95); border: 1px solid #1f2937; color: var(--muted); }

    .btn-ghost.danger { border-color: rgba(248,113,113,0.7); color: #fecaca; }
    .btn-ghost.secondary { border-color: rgba(148,163,184,0.6); }

    .rr-block {
      margin-top: 12px; padding-top: 10px; border-top: 1px dashed #1f2937;
      font-size: 11px; color: var(--muted);
    }

    .rr-title { font-size: 11px; font-weight: 600; color: #e5e7eb; margin-bottom: 6px; }

    .rr-list { margin-top: 6px; padding-left: 14px; }
    .rr-list li { margin-bottom: 4px; }

  </style>
</head>

<body>
  <div class="app-shell">
    <header>
      <div class="brand">
        <div class="brand-icon">PB</div>
        <div>
          <div class="brand-text-title">PicklePulse</div>
          <div class="brand-text-sub">Your pickleball stats & RR tracker</div>
        </div>
      </div>

      <div class="tagline">Log matches fast. Auto RR mode. DUPR-style rating.</div>
    </header>

    <div class="grid">

      <!-- LEFT SIDE: MATCH FORM -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Add Match</div>
            <div class="card-subtitle">Singles & doubles, fast logging.</div>
          </div>
          <div class="pill"><span>üèì</span> Local Save</div>
        </div>

        <form id="match-form">

          <!-- FORMAT -->
          <div class="field">
            <label for="playMode">Format</label>
            <select id="playMode" onchange="updateFormatUI()">
              <option value="doubles">Doubles (2 vs 2)</option>
              <option value="singles">Singles (1 vs 1)</option>
            </select>
          </div>

          <!-- DATE -->
          <div class="field">
            <label for="date">Date</label>
            <input id="date" type="date" />
          </div>

          <!-- PLAYERS -->
          <div class="field">
            <label for="player1">Player 1</label>
            <input id="player1" type="text" placeholder="e.g. Neil" required />
          </div>

          <div class="field">
            <label for="player2">Player 2 / Opponent (Singles)</label>
            <input id="player2" type="text" placeholder="e.g. Matt" />
          </div>

          <div class="field" id="p3field">
            <label for="player3">Player 3 (Opponent 1)</label>
            <input id="player3" type="text" placeholder="Opponent 1" />
          </div>

          <div class="field" id="p4field">
            <label for="player4">Player 4 (Opponent 2)</label>
            <input id="player4" type="text" placeholder="Opponent 2" />
          </div>

          <!-- SCORE -->
          <div class="field field-full">
            <label>Score (Your side vs Opponents)</label>
            <div class="score-inputs">
              <input id="scoreUs" type="number" min="0" max="21" placeholder="11" />
              <span>‚Äì</span>
              <input id="scoreThem" type="number" min="0" max="21" placeholder="7" />
            </div>

            <div class="chips-row">
              <button type="button" class="chip-toggle active" data-win-state="auto">Auto win/loss</button>
              <button type="button" class="chip-toggle" data-win-state="win">Force Win</button>
              <button type="button" class="chip-toggle" data-win-state="loss">Force Loss</button>

              <button type="button" class="chip-toggle" id="roundRobinToggle">Round robin: OFF</button>
            </div>
          </div>
                    <!-- MATCH TYPE -->
          <div class="field">
            <label for="matchType">Match Type</label>
            <select id="matchType">
              <option value="rec">Rec Play</option>
              <option value="ladder">Ladder</option>
              <option value="league">League</option>
              <option value="tournament">Tournament</option>
              <option value="drills">Drills / Practice</option>
            </select>
          </div>

          <div class="field">
            <label for="location">Location</label>
            <input id="location" type="text" placeholder="e.g. PickleRage Nocatee" />
          </div>

          <div class="field field-full">
            <label for="notes">Quick Notes (optional)</label>
            <textarea id="notes" placeholder="e.g. Backhand felt great."></textarea>
          </div>

          <div class="btn-row field-full">
            <button type="submit" class="btn-primary">+ Save Match</button>
            <button type="button" id="clearAll" class="btn-ghost danger">Clear All</button>
          </div>
        </form>

        <!-- ROUND ROBIN GENERATOR -->
        <div class="rr-block">
          <div class="rr-title">Round Robin Generator</div>
          <div>Enter 4 players. Choose format. Then generate RR.</div>

          <div class="btn-row" style="margin-top: 8px;">
            <button type="button" id="generateRR" class="btn-ghost secondary">
              Generate RR Schedule
            </button>
          </div>

          <div class="rr-view">
            <ul id="rrList" class="rr-list"></ul>
          </div>
        </div>
      </section>

      <!-- RIGHT SIDE: STATS + MATCH LIST -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Your Stats</div>
            <div class="card-subtitle">Wins, streaks, rating & history.</div>
          </div>
          <div class="pill" id="ratingPill">Rating: 3.50</div>
        </div>

        <!-- QUICK STATS -->
        <div class="stats-grid" style="
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 12px;
          margin-bottom: 14px;
        ">
          <div class="card-mini" style="background:#020617;border:1px solid #1f2937;border-radius:16px;padding:12px;">
            <div style="font-size:11px;color:var(--muted);">Total Matches</div>
            <div id="statTotal" style="font-weight:700;margin-top:4px;">0</div>
          </div>

          <div class="card-mini" style="background:#020617;border:1px solid #1f2937;border-radius:16px;padding:12px;">
            <div style="font-size:11px;color:var(--muted);">Win %</div>
            <div id="statWinPct" style="font-weight:700;margin-top:4px;">0%</div>
          </div>

          <div class="card-mini" style="background:#020617;border:1px solid #1f2937;border-radius:16px;padding:12px;">
            <div style="font-size:11px;color:var(--muted);">Wins</div>
            <div id="statWins" style="font-weight:700;margin-top:4px;">0</div>
          </div>

          <div class="card-mini" style="background:#020617;border:1px solid #1f2937;border-radius:16px;padding:12px;">
            <div style="font-size:11px;color:var(--muted);">Losses</div>
            <div id="statLosses" style="font-weight:700;margin-top:4px;">0</div>
          </div>

          <div class="card-mini" style="background:#020617;border:1px solid #1f2937;border-radius:16px;padding:12px;">
            <div style="font-size:11px;color:var(--muted);">Streak</div>
            <div id="statStreak" style="font-weight:700;margin-top:4px;">0</div>
          </div>

          <div class="card-mini" style="background:#020617;border:1px solid #1f2937;border-radius:16px;padding:12px;">
            <div style="font-size:11px;color:var(--muted);">Best Partner</div>
            <div id="statPartner" style="font-weight:700;margin-top:4px;">‚Äì</div>
          </div>
        </div>

        <!-- RESET STATS -->
        <button id="resetStats" class="btn-ghost danger" style="width:100%;margin-bottom:12px;">
          Reset All Data
        </button>

        <!-- MATCH HISTORY -->
        <div class="matches">
          <div class="match-row header">
            <div>Match</div>
            <div>Score</div>
            <div>Result</div>
            <div>Date</div>
          </div>
          <div id="matchList">
            <div class="empty-state">No matches yet ‚Äî log one!</div>
          </div>
        </div>
      </section>
    </div> <!-- END GRID -->

    <!-- ============================================================
         ROUND ROBIN + MATCH ENGINE SCRIPT
    ============================================================ -->
<script>

/* -------------------------------------------------------------
   SINGLES MODE UI: Hide Player 3 & Player 4 automatically
------------------------------------------------------------- */
function updateFormatUI() {
  const mode = document.getElementById("playMode").value;
  const p3 = document.getElementById("p3field");
  const p4 = document.getElementById("p4field");

  if (mode === "singles") {
    p3.style.display = "none";
    p4.style.display = "none";
    document.getElementById("player3").value = "";
    document.getElementById("player4").value = "";
  } else {
    p3.style.display = "block";
    p4.style.display = "block";
  }
}

updateFormatUI(); // call on load

/* ============================================================
   RR STATE
============================================================ */
let rrSchedule = null;
let rrIndex = 0;
let rrActive = false;
let rrFormatLocked = null;

function saveRRState() {
  localStorage.setItem("rrState", JSON.stringify({
    schedule: rrSchedule,
    index: rrIndex,
    active: rrActive,
    format: rrFormatLocked
  }));
}

function loadRRState() {
  const saved = localStorage.getItem("rrState");
  if (!saved) return;

  const state = JSON.parse(saved);
  rrSchedule = state.schedule;
  rrIndex = state.index;
  rrActive = state.active;
  rrFormatLocked = state.format;

  if (rrActive) {
    const toggle = document.getElementById("roundRobinToggle");
    toggle.classList.add("active");
    toggle.textContent = "Round robin: ON";

    document.getElementById("playMode").value = rrFormatLocked;
    document.getElementById("playMode").disabled = true;

    renderRRList();
    autofillNextRRMatch();
  }
}

function clearRRState() {
  rrSchedule = null;
  rrIndex = 0;
  rrActive = false;
  rrFormatLocked = null;
  localStorage.removeItem("rrState");

  document.getElementById("rrList").innerHTML = "";
  const toggle = document.getElementById("roundRobinToggle");
  toggle.classList.remove("active");
  toggle.textContent = "Round robin: OFF";

  document.getElementById("playMode").disabled = false;
}

/* ============================================================
   RR MATCH GENERATION (Singles or Doubles)
============================================================ */
function generateRoundRobin(players, mode) {
  const matches = [];

  if (mode === "singles") {
    for (let i = 0; i < players.length; i++) {
      for (let j = i + 1; j < players.length; j++) {
        matches.push({
          type: "singles",
          p1: players[i],
          p2: players[j]
        });
      }
    }
  } else {
    matches.push({ type: "doubles", team1:[players[0],players[1]], team2:[players[2],players[3]] });
    matches.push({ type: "doubles", team1:[players[0],players[2]], team2:[players[1],players[3]] });
    matches.push({ type: "doubles", team1:[players[0],players[3]], team2:[players[1],players[2]] });
  }

  return matches;
}

/* ============================================================
   RENDER RR LIST
============================================================ */
function renderRRList() {
  const ul = document.getElementById("rrList");
  ul.innerHTML = "";

  if (!rrSchedule) return;

  rrSchedule.forEach((m, idx) => {
    let text = "";

    if (m.type === "singles") {
      text = `${m.p1} vs ${m.p2}`;
    } else {
      text = `${m.team1[0]} & ${m.team1[1]} vs ${m.team2[0]} & ${m.team2[1]}`;
    }

    const li = document.createElement("li");
    li.textContent = (idx === rrIndex ? "üëâ " : "") + text;
    ul.appendChild(li);
  });
}

/* ============================================================
   AUTOFILL NEXT RR MATCH
============================================================ */
function autofillNextRRMatch() {
  if (!rrActive || !rrSchedule || rrIndex >= rrSchedule.length) return;

  const match = rrSchedule[rrIndex];

  const modeEl = document.getElementById("playMode");

  if (match.type === "singles") {
    modeEl.value = "singles";
    modeEl.disabled = true;

    document.getElementById("player1").value = match.p1;
    document.getElementById("player2").value = match.p2;
    document.getElementById("player3").value = "";
    document.getElementById("player4").value = "";

    updateFormatUI();
  } else {
    modeEl.value = "doubles";
    modeEl.disabled = true;

    document.getElementById("player1").value = match.team1[0];
    document.getElementById("player2").value = match.team1[1];
    document.getElementById("player3").value = match.team2[0];
    document.getElementById("player4").value = match.team2[1];

    updateFormatUI();
  }

  document.getElementById("scoreUs").value = "";
  document.getElementById("scoreThem").value = "";
  document.getElementById("notes").value = "";

  const toggle = document.getElementById("roundRobinToggle");
  toggle.classList.add("active");
  toggle.textContent = "Round robin: ON";

  renderRRList();
}

/* ============================================================
   ADVANCE RR MATCH
============================================================ */
function advanceRR() {
  rrIndex++;

  if (rrIndex >= rrSchedule.length) {
    alert("üéâ Round Robin Complete ‚Äî All matches played!");
    clearRRState();
    return;
  }

  saveRRState();
  autofillNextRRMatch();
}

/* ============================================================
   GENERATE RR BUTTON
============================================================ */
document.getElementById("generateRR").addEventListener("click", () => {
  const mode = document.getElementById("playMode").value;

  const p1 = player1.value.trim();
  const p2 = player2.value.trim();
  const p3 = player3.value.trim();
  const p4 = player4.value.trim();

  if (!p1 || !p2 || !p3 || !p4) {
    alert("Enter all 4 player names to generate RR.");
    return;
  }

  const players = [p1, p2, p3, p4];

  rrSchedule = generateRoundRobin(players, mode);
  rrIndex = 0;
  rrActive = true;
  rrFormatLocked = mode;

  saveRRState();
  renderRRList();
  autofillNextRRMatch();
});

/* ============================================================
   RR TOGGLE BUTTON
============================================================ */
document.getElementById("roundRobinToggle").addEventListener("click", () => {
  if (rrActive) clearRRState();
  else {
    rrActive = true;
    const t = document.getElementById("roundRobinToggle");
    t.classList.add("active");
    t.textContent = "Round robin: ON";
    saveRRState();
  }
});

/* ============================================================
   MATCH STORAGE + STATS
============================================================ */
let matches = JSON.parse(localStorage.getItem("matches") || "[]");

function saveMatches() {
  localStorage.setItem("matches", JSON.stringify(matches));
}

function calculateRating() {
  let rating = 3.5;

  matches.forEach(m => {
    const diff = m.scoreUs - m.scoreThem;

    if (m.result === "win") rating += 0.01 + diff * 0.001;
    else rating -= 0.01 + Math.abs(diff) * 0.001;
  });

  if (rating < 2.0) rating = 2.0;
  if (rating > 6.5) rating = 6.5;

  return rating.toFixed(2);
}

function updateStats() {
  const total = matches.length;
  const wins = matches.filter(m => m.result === "win").length;
  const losses = total - wins;
  const winPct = total ? Math.round((wins / total) * 100) + "%" : "0%";

  let streak = 0;
  for (let i = matches.length - 1; i >= 0; i--) {
    if (matches[i].result === "win") streak++;
    else break;
  }

  const partnerCounts = {};
  matches.forEach(m => {
    if (m.partner && m.result === "win") {
      partnerCounts[m.partner] = (partnerCounts[m.partner] || 0) + 1;
    }
  });

  let bestPartner = "‚Äì";
  if (Object.keys(partnerCounts).length) {
    bestPartner = Object.entries(partnerCounts).sort((a, b) => b[1] - a[1])[0][0];
  }

  statTotal.textContent = total;
  statWins.textContent = wins;
  statLosses.textContent = losses;
  statWinPct.textContent = winPct;
  statStreak.textContent = streak;
  statPartner.textContent = bestPartner;

  ratingPill.textContent = "Rating: " + calculateRating();
}

/* ============================================================
   RENDER MATCH HISTORY
============================================================ */
function renderMatches() {
  matchList.innerHTML = "";

  if (matches.length === 0) {
    matchList.innerHTML = `<div class="empty-state">No matches yet ‚Äî log one!</div>`;
    return;
  }

  matches.slice().reverse().forEach(m => {
    const row = document.createElement("div");
    row.className = "match-row";

    const players = m.mode === "singles"
      ? `${m.p1} vs ${m.p2}`
      : `${m.p1} & ${m.p2} vs ${m.p3} & ${m.p4}`;

    row.innerHTML = `
      <div class="match-main">
        <div class="match-title">${players}</div>
        <div class="match-meta">${m.type} ‚Ä¢ ${m.location || "No location"}</div>
      </div>

      <div class="score">${m.scoreUs} ‚Äì ${m.scoreThem}</div>

      <div>
        <span class="badge ${m.result === "win" ? "win" : "loss"}">${m.result}</span>
      </div>

      <div>${m.date}</div>
    `;

    matchList.appendChild(row);
  });
}

/* ============================================================
   MATCH SUBMIT HANDLER
============================================================ */
document.getElementById("match-form").addEventListener("submit", (e) => {
  e.preventDefault();

  const mode = playMode.value;

  const p1 = player1.value.trim();
  const p2 = player2.value.trim();
  const p3 = player3.value.trim();
  const p4 = player4.value.trim();

  const scoreUsVal = parseInt(scoreUs.value);
  const scoreThemVal = parseInt(scoreThem.value);

  if (isNaN(scoreUsVal) || isNaN(scoreThemVal)) {
    alert("Score is required.");
    return;
  }

  let result = scoreUsVal > scoreThemVal ? "win" : "loss";

  let players = {};
  if (mode === "singles") {
    players = { p1, p2 };
  } else {
    players = { p1, p2, p3, p4 };
  }

  matches.push({
    mode,
    type: matchType.value,
    ...players,
    scoreUs: scoreUsVal,
    scoreThem: scoreThemVal,
    result,
    partner: mode === "doubles" ? p2 : null,
    location: location.value.trim(),
    notes: notes.value.trim(),
    date: date.value || new Date().toISOString().slice(0, 10)
  });

  saveMatches();
  updateStats();
  renderMatches();

  if (rrActive) {
    setTimeout(() => {
      advanceRR();
    }, 150);
  }
});

/* ============================================================
   CLEAR INPUTS
============================================================ */
clearAll.addEventListener("click", () => {
  player1.value = "";
  player2.value = "";
  player3.value = "";
  player4.value = "";
  scoreUs.value = "";
  scoreThem.value = "";
  location.value = "";
  notes.value = "";
});

/* ============================================================
   RESET ALL DATA
============================================================ */
resetStats.addEventListener("click", () => {
  if (!confirm("Delete ALL match data?")) return;

  matches = [];
  saveMatches();
  updateStats();
  renderMatches();
  clearRRState();
});

loadRRState();
updateStats();
renderMatches();

</script>

</body>
</html>