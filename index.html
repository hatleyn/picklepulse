<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PicklePulse ‚Äî Pickleball Stats & Rating Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050816;
      --card: #0f172a;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #ef4444;
      --border: #1f2937;
      --radius-lg: 18px;
      --radius-xl: 24px;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 40%, #000 100%);
      color: var(--text);
      padding: 16px;
    }

    .app-shell {
      max-width: 960px;
      margin: 0 auto 40px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-icon {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #4ade80, #22c55e);
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: #022c22;
      font-size: 20px;
    }

    .brand-text-title {
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 0.02em;
    }

    .brand-text-sub {
      font-size: 12px;
      color: var(--muted);
    }

    header .tagline {
      font-size: 12px;
      text-align: right;
      color: var(--muted);
      max-width: 180px;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 1fr);
      gap: 16px;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      header .tagline {
        text-align: left;
      }
    }

    .card {
      background: radial-gradient(circle at top left, #111827, #020617);
      border-radius: var(--radius-xl);
      padding: 16px 14px 14px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.55);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--muted);
    }

    .pill {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    form {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field-full {
      grid-column: 1 / -1;
    }

    label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
    }

    input, select, textarea {
      background: #020617;
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 8px 10px;
      color: var(--text);
      font-size: 13px;
      outline: none;
      width: 100%;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.5);
    }

    textarea {
      resize: vertical;
      min-height: 48px;
      max-height: 120px;
      line-height: 1.4;
    }

    .score-inputs {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .score-inputs input {
      text-align: center;
    }

    .score-inputs span {
      font-size: 11px;
      color: var(--muted);
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .chip-toggle {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      cursor: pointer;
      color: var(--muted);
    }

    .chip-toggle.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 9px 12px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        background 0.12s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #4ade80);
      color: #022c22;
      box-shadow: 0 10px 25px rgba(34, 197, 94, 0.55);
      flex: 1;
    }

    .btn-primary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.95);
      color: var(--muted);
      border: 1px solid #1f2937;
    }

    .btn-ghost.danger {
      border-color: rgba(248, 113, 113, 0.7);
      color: #fecaca;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }

    .stat-card {
      background: radial-gradient(circle at top, #020617, #020617);
      border-radius: 16px;
      border: 1px solid #111827;
      padding: 10px 10px 9px;
    }

    .stat-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 2px;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 700;
    }

    .stat-tag {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--accent);
      margin-top: 2px;
    }

    .stat-sub {
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
    }

    .rating-card {
      border-radius: 16px;
      padding: 10px 10px 9px;
      border: 1px solid rgba(34, 197, 94, 0.7);
      background: radial-gradient(circle at top, #022c22, #020617);
      box-shadow: 0 12px 30px rgba(16, 185, 129, 0.35);
    }

    .matches {
      max-height: 330px;
      overflow: auto;
      border-radius: 14px;
      border: 1px solid #111827;
      background: radial-gradient(circle at top left, #020617, #020617);
    }

    .match-row {
      display: grid;
      grid-template-columns: 1.2fr 0.9fr 0.6fr 0.6fr;
      padding: 8px 10px;
      font-size: 11px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.9);
      align-items: center;
      gap: 6px;
    }

    .match-row.header {
      position: sticky;
      top: 0;
      z-index: 2;
      background: linear-gradient(to bottom, #020617, #020617);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      font-size: 10px;
    }

    .match-row:last-child {
      border-bottom: none;
    }

    .match-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .match-title {
      font-size: 11px;
    }

    .match-meta {
      font-size: 10px;
      color: var(--muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--muted);
    }

    .badge.win {
      border-color: rgba(34, 197, 94, 0.85);
      color: #bbf7d0;
      background: rgba(22, 163, 74, 0.2);
    }

    .badge.loss {
      border-color: rgba(248, 113, 113, 0.85);
      color: #fecaca;
      background: rgba(127, 29, 29, 0.35);
    }

    .badge.type {
      border-style: dashed;
    }

    .score {
      font-weight: 600;
      font-size: 12px;
    }

    .empty-state {
      padding: 16px 10px;
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }

    .footer-note {
      margin-top: 10px;
      font-size: 10px;
      color: var(--muted);
      text-align: right;
    }

    .footer-note span {
      color: var(--accent);
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="brand">
        <div class="brand-icon">PB</div>
        <div>
          <div class="brand-text-title">PicklePulse</div>
          <div class="brand-text-sub">Your pickleball stats & rating tracker</div>
        </div>
      </div>
      <div class="tagline">
        Log matches in seconds. Track wins, partners, and a DUPR-style rating over time.
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Match Form -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Add Match</div>
            <div class="card-subtitle">Just finished a game? Log it in under 15 seconds.</div>
          </div>
          <div class="pill">
            <span>üèì</span> Live on this device
          </div>
        </div>

        <form id="match-form">
          <div class="field">
            <label for="playMode">Format</label>
            <select id="playMode">
              <option value="doubles">Doubles (2 vs 2)</option>
              <option value="singles">Singles (1 vs 1)</option>
            </select>
          </div>

          <div class="field">
            <label for="date">Date</label>
            <input id="date" type="date" />
          </div>

          <div class="field">
            <label for="player1">Player 1</label>
            <input id="player1" type="text" placeholder="e.g. Neil" required />
          </div>

          <div class="field">
            <label for="player2">Player 2</label>
            <input id="player2" type="text" placeholder="Partner (doubles)" />
          </div>

          <div class="field">
            <label for="player3">Player 3</label>
            <input id="player3" type="text" placeholder="Opponent 1" />
          </div>

          <div class="field">
            <label for="player4">Player 4</label>
            <input id="player4" type="text" placeholder="Opponent 2 (doubles)" />
          </div>

          <div class="field field-full">
            <label>Score (Your side vs Opponents)</label>
            <div class="score-inputs">
              <input id="scoreUs" type="number" min="0" max="21" placeholder="11" />
              <span>‚Äì</span>
              <input id="scoreThem" type="number" min="0" max="21" placeholder="7" />
            </div>
            <div class="chips-row">
              <button type="button" class="chip-toggle active" data-win-state="auto">
                Auto win/loss from score
              </button>
              <button type="button" class="chip-toggle" data-win-state="win">Force Win</button>
              <button type="button" class="chip-toggle" data-win-state="loss">Force Loss</button>
              <button type="button" class="chip-toggle" id="roundRobinToggle">
                Round robin: OFF
              </button>
            </div>
          </div>

          <div class="field">
            <label for="matchType">Match Type</label>
            <select id="matchType">
              <option value="rec">Rec Play</option>
              <option value="ladder">Ladder</option>
              <option value="league">League</option>
              <option value="tournament">Tournament</option>
              <option value="drills">Drills / Practice</option>
            </select>
          </div>

          <div class="field">
            <label for="location">Location</label>
            <input id="location" type="text" placeholder="e.g. PickleRage Nocatee" />
          </div>

          <div class="field field-full">
            <label for="notes">Quick Notes (optional)</label>
            <textarea id="notes" placeholder="e.g. Struggled on backhand dinks, strong drives from left side."></textarea>
          </div>

          <div class="btn-row field-full">
            <button type="submit" class="btn-primary">
              + Save Match
            </button>
            <button type="button" id="clearAll" class="btn-ghost danger">
              Clear All
            </button>
          </div>
        </form>
      </section>

      <!-- RIGHT: Stats & Matches -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Your Numbers</div>
            <div class="card-subtitle">See your trend, not just today‚Äôs game.</div>
          </div>
          <div class="pill">
            <span>üìà</span> Live stats
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card rating-card">
            <div class="stat-label">Estimated Rating</div>
            <div class="stat-value" id="rating">‚Äì</div>
            <div class="stat-tag" id="ratingTag">New Player</div>
            <div class="stat-sub" id="ratingSub">
              Starts at 3.00 and adjusts slightly per match (this is not official DUPR).
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-label">Record</div>
            <div class="stat-value" id="record">0‚Äì0</div>
            <div class="stat-sub" id="recordSub">0.0% win rate</div>
          </div>

          <div class="stat-card">
            <div class="stat-label">Most Played Partner</div>
            <div class="stat-value" id="topPartner">‚Äì</div>
            <div class="stat-sub" id="topPartnerSub">No data yet</div>
          </div>
        </div>

        <div class="matches" id="matchesContainer">
          <div class="match-row header">
            <div>Match</div>
            <div>Type</div>
            <div>Score</div>
            <div>Result</div>
          </div>
          <div class="empty-state" id="emptyState">
            No matches logged yet. Play a game, then add your first result on the left.
          </div>
        </div>

        <div class="footer-note">
          Stored locally in your browser. <span>Future version</span> will sync to the cloud
          via Pipedream & Google Sheets.
        </div>
      </section>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "pickle_pulse_matches_v1";

    function loadMatches() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error("Failed to parse storage", e);
        return [];
      }
    }

    function saveMatches(matches) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(matches));
    }

    const form = document.getElementById("match-form");
    const clearAllBtn = document.getElementById("clearAll");
    const matchesContainer = document.getElementById("matchesContainer");
    const emptyState = document.getElementById("emptyState");
    const ratingEl = document.getElementById("rating");
    const ratingTagEl = document.getElementById("ratingTag");
    const ratingSubEl = document.getElementById("ratingSub");
    const recordEl = document.getElementById("record");
    const recordSubEl = document.getElementById("recordSub");
    const topPartnerEl = document.getElementById("topPartner");
    const topPartnerSubEl = document.getElementById("topPartnerSub");
    const chipToggles = Array.from(document.querySelectorAll(".chip-toggle"));
    const playModeSelect = document.getElementById("playMode");
    const roundRobinToggle = document.getElementById("roundRobinToggle");

    const player1Input = document.getElementById("player1");
    const player2Input = document.getElementById("player2");
    const player3Input = document.getElementById("player3");
    const player4Input = document.getElementById("player4");

    let matches = loadMatches();
    let winStateMode = "auto";
    let roundRobinOn = false;

    // Win/Loss mode chips
    chipToggles.forEach((chip) => {
      if (chip === roundRobinToggle) return;
      chip.addEventListener("click", () => {
        const mode = chip.getAttribute("data-win-state");
        winStateMode = mode;
        chipToggles.forEach((c) => {
          if (c !== roundRobinToggle) c.classList.remove("active");
        });
        chip.classList.add("active");
      });
    });

    // Round robin toggle
    roundRobinToggle.addEventListener("click", () => {
      roundRobinOn = !roundRobinOn;
      roundRobinToggle.classList.toggle("active", roundRobinOn);
      roundRobinToggle.textContent = roundRobinOn
        ? "Round robin: ON"
        : "Round robin: OFF";
    });

    // Singles vs Doubles UI
    function updatePlayModeUI() {
      const mode = playModeSelect.value;
      if (mode === "singles") {
        player2Input.value = "";
        player4Input.value = "";
        player2Input.disabled = true;
        player4Input.disabled = true;
        player2Input.placeholder = "N/A in singles";
        player4Input.placeholder = "N/A in singles";
      } else {
        player2Input.disabled = false;
        player4Input.disabled = false;
        player2Input.placeholder = "Partner (doubles)";
        player4Input.placeholder = "Opponent 2 (doubles)";
      }
    }

    playModeSelect.addEventListener("change", updatePlayModeUI);

    function deriveWinFromScore(us, them) {
      if (us == null || them == null || isNaN(us) || isNaN(them)) return null;
      if (us === them) return null;
      return us > them;
    }

    function formatDateLabel(iso) {
      if (!iso) return "No date";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return "No date";
      return d.toLocaleDateString(undefined, {
        month: "short",
        day: "numeric",
      });
    }

    function computeStats(matches) {
      const total = matches.length;
      if (!total) {
        return {
          wins: 0,
          losses: 0,
          winPct: 0,
          rating: null,
          topPartner: null,
          topPartnerRecord: null,
        };
      }

      let wins = 0;
      let losses = 0;
      const partnerStats = {};

      for (const m of matches) {
        if (m.result === "win") wins++;
        else if (m.result === "loss") losses++;

        const p =
          (m.format === "doubles" && m.player2 && m.player2.trim()) ||
          (m.partner || "").trim();
        if (p) {
          if (!partnerStats[p]) {
            partnerStats[p] = { wins: 0, losses: 0, count: 0 };
          }
          partnerStats[p].count++;
          if (m.result === "win") partnerStats[p].wins++;
          else if (m.result === "loss") partnerStats[p].losses++;
        }
      }

      const winPct = total > 0 ? (wins / total) * 100 : 0;

      let rating = 3.0;
      for (const m of matches) {
        if (m.result === "win") {
          let delta = 0.03;
          if (m.scoreUs >= 11 && m.scoreThem <= 4) delta += 0.01;
          rating += delta;
        } else if (m.result === "loss") {
          let delta = -0.02;
          if (m.scoreThem >= 11 && m.scoreUs <= 4) delta -= 0.01;
          rating += delta;
        }
      }
      rating = Math.max(2.5, Math.min(5.5, rating));

      let topPartner = null;
      let topPartnerRecord = null;

      Object.entries(partnerStats).forEach(([name, stats]) => {
        if (!topPartner || stats.count > topPartner.count) {
          topPartner = { name, ...stats };
        }
      });

      if (topPartner) {
        topPartnerRecord = `${topPartner.wins}-${topPartner.losses}`;
      }

      return { wins, losses, winPct, rating, topPartner, topPartnerRecord };
    }

    function ratingTag(rating) {
      if (rating == null)
        return { tag: "New Player", sub: "Log a few matches to see your trend." };
      if (rating < 3.2)
        return {
          tag: "Building Foundation",
          sub: "Work on consistent dinks & serves. You're stacking experience.",
        };
      if (rating < 3.6)
        return {
          tag: "Solid Rec Player",
          sub: "You're gaining control. Focus on third-shot drops & soft game.",
        };
      if (rating < 4.0)
        return {
          tag: "Competitive",
          sub: "You can hang with strong players. Target weaknesses from your notes.",
        };
      if (rating < 4.5)
        return {
          tag: "Advanced",
          sub: "You likely dominate rec. Seek higher-level games and structured drilling.",
        };
      return {
        tag: "Elite",
        sub: "Your stats look legit. Use this tracker to prep for tournaments.",
      };
    }

    function buildMatchTitle(m) {
      const p1 = m.player1 || "Player 1";
      const p2 = m.player2 || "";
      const p3 = m.player3 || "Player 3";
      const p4 = m.player4 || "";

      if (m.format === "singles") {
        return `${p1} vs ${p3}`;
      } else {
        const left = [p1, p2].filter(Boolean).join(" & ") || "Team 1";
        const right = [p3, p4].filter(Boolean).join(" & ") || "Team 2";
        return `${left} vs ${right}`;
      }
    }

    function render() {
      const { wins, losses, winPct, rating, topPartner, topPartnerRecord } =
        computeStats(matches);

      ratingEl.textContent = rating == null ? "‚Äì" : rating.toFixed(2);

      const tagInfo = ratingTag(rating);
      ratingTagEl.textContent = tagInfo.tag;
      ratingSubEl.textContent = tagInfo.sub;

      recordEl.textContent = `${wins}-${losses}`;
      recordSubEl.textContent = `${winPct.toFixed(1)}% win rate`;

      if (topPartner) {
        topPartnerEl.textContent = topPartner.name;
        topPartnerSubEl.textContent = `${topPartnerRecord} with this partner`;
      } else {
        topPartnerEl.textContent = "‚Äì";
        topPartnerSubEl.textContent = "No data yet";
      }

      const existingRows = Array.from(
        matchesContainer.querySelectorAll(".match-row.data-row")
      );
      existingRows.forEach((r) => r.remove());

      if (!matches.length) {
        emptyState.style.display = "block";
      } else {
        emptyState.style.display = "none";
      }

      matches
        .slice()
        .reverse()
        .forEach((m) => {
          const row = document.createElement("div");
          row.className = "match-row data-row";

          const main = document.createElement("div");
          main.className = "match-main";
          const title = document.createElement("div");
          title.className = "match-title";
          title.textContent = buildMatchTitle(m);
          const meta = document.createElement("div");
          meta.className = "match-meta";
          meta.textContent = `${formatDateLabel(m.date)} ‚Ä¢ ${
            m.location || "Unknown court"
          }`;
          main.appendChild(title);
          main.appendChild(meta);

          const typeCell = document.createElement("div");
          const badges = document.createElement("div");
          badges.className = "badge-row";

          const typeBadge = document.createElement("span");
          typeBadge.className = "badge type";
          typeBadge.textContent = m.matchTypeLabel || "Rec";
          badges.appendChild(typeBadge);

          const formatBadge = document.createElement("span");
          formatBadge.className = "badge";
          formatBadge.textContent =
            m.format === "singles" ? "Singles" : "Doubles";
          badges.appendChild(formatBadge);

          if (m.roundRobin) {
            const rrBadge = document.createElement("span");
            rrBadge.className = "badge";
            rrBadge.textContent = "RR";
            badges.appendChild(rrBadge);
          }

          typeCell.appendChild(badges);

          const scoreCell = document.createElement("div");
          scoreCell.className = "score";
          scoreCell.textContent =
            m.scoreUs != null && m.scoreThem != null
              ? `${m.scoreUs}-${m.scoreThem}`
              : "‚Äì";

          const resultCell = document.createElement("div");
          const resultBadge = document.createElement("span");
          resultBadge.className = "badge";
          if (m.result === "win") {
            resultBadge.classList.add("win");
            resultBadge.textContent = "Win";
          } else if (m.result === "loss") {
            resultBadge.classList.add("loss");
            resultBadge.textContent = "Loss";
          } else {
            resultBadge.textContent = "‚Äî";
          }
          resultCell.appendChild(resultBadge);

          row.appendChild(main);
          row.appendChild(typeCell);
          row.appendChild(scoreCell);
          row.appendChild(resultCell);
          matchesContainer.appendChild(row);
        });
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const format = playModeSelect.value;
      const player1 = player1Input.value.trim();
      const player2 = player2Input.value.trim();
      const player3 = player3Input.value.trim();
      const player4 = player4Input.value.trim();

      const scoreUsRaw = document.getElementById("scoreUs").value;
      const scoreThemRaw = document.getElementById("scoreThem").value;
      const matchType = document.getElementById("matchType").value;
      const location = document.getElementById("location").value.trim();
      const notes = document.getElementById("notes").value.trim();
      const dateRaw = document.getElementById("date").value;

      if (!player1 || !player3) {
        alert("Please enter at least Player 1 and Player 3.");
        return;
      }

      if (scoreUsRaw === "" || scoreThemRaw === "") {
        alert("Please enter both scores (your side and opponents).");
        return;
      }

      let scoreUs = Number(scoreUsRaw);
      let scoreThem = Number(scoreThemRaw);

      if (isNaN(scoreUs) || isNaN(scoreThem)) {
        alert("Scores must be numbers.");
        return;
      }

      let result = null;
      if (winStateMode === "win") result = "win";
      else if (winStateMode === "loss") result = "loss";
      else {
        const derived = deriveWinFromScore(scoreUs, scoreThem);
        if (derived === true) result = "win";
        else if (derived === false) result = "loss";
        else result = null;
      }

      const matchTypeLabelMap = {
        rec: "Rec",
        ladder: "Ladder",
        league: "League",
        tournament: "Tournament",
        drills: "Drills",
      };

      const payload = {
        id: Date.now(),
        // legacy field for compatibility
        playerName: player1,
        partner: player2,
        opponents: [player3, player4].filter(Boolean).join(" & "),
        // new fields
        player1,
        player2: format === "doubles" ? player2 : "",
        player3,
        player4: format === "doubles" ? player4 : "",
        format,
        roundRobin: roundRobinOn,
        scoreUs,
        scoreThem,
        result,
        matchType,
        matchTypeLabel: matchTypeLabelMap[matchType] || "Rec",
        location,
        notes,
        date: dateRaw || new Date().toISOString(),
        createdAt: new Date().toISOString(),
      };

      matches.push(payload);
      saveMatches(matches);
      render();

      // Keep players for RR sessions; just clear fast-changing stuff
      document.getElementById("scoreUs").value = "";
      document.getElementById("scoreThem").value = "";
      document.getElementById("notes").value = "";
      document.getElementById("location").value = "";
    });

    clearAllBtn.addEventListener("click", () => {
      if (!matches.length) return;
      const yes = confirm(
        "Clear all matches from this device? This cannot be undone."
      );
      if (!yes) return;
      matches = [];
      saveMatches(matches);
      render();
    });

    // Prefill date & mode UI
    const dateInput = document.getElementById("date");
    if (dateInput && !dateInput.value) {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      dateInput.value = `${yyyy}-${mm}-${dd}`;
    }

    updatePlayModeUI();
    render();
  </script>
</body>
</html>